<!DOCTYPE html>
<!--  lastBuildDate : Wed, 07 Feb 2018 11:42:52 +0100 -->
<html>
<head>
  
  
  <title>Mktd#1 Feign Vs Retrofit &#58; 2 Aller Plus Loin</title>
  
  <!-- Meta -->
  <meta charset="utf-8">
  <meta http-equiv="content-language" content="fr" />
  <meta name="language" content="fr" />
  <!-- Google site verification -->
  <meta name="google-site-verification" content="Gq_ytzUtfYn95WsiH66e4Lfb8zANT-LUwD8JgH9xXdw" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <meta name="keywords" content="Expertise informatique, Dévelopement informatique" />

  <!-- RSS feed -->
  <link rel="alternate" type="application/rss+xml" title=" RSS Feed" href="http://www.monkeypatch.io/blog/feed.xml" />

  <!-- SEO -->
  <meta property="og:title" content="Mktd#1 Feign Vs Retrofit &#58; 2 Aller Plus Loin" />

  
  <meta property="og:description" content="Cet article est le deuxième d’une série de trois articles sur les clients REST en java que sont Feign et Retrofit.

Article précédent :
MKTD#1 : Prise en main



Défi 2: Aller plus loin…

Le deuxième défi permet d’adresser des problèmes plus avancés comme :


  L’authentification
  La gestion des erreurs via des Exception Java
  L’upload et le download de fichiers


" />
  <meta name="description" content="Cet article est le deuxième d’une série de trois articles sur les clients REST en java que sont Feign et Retrofit.

Article précédent :
MKTD#1 : Prise en main



Défi 2: Aller plus loin…

Le deuxième défi permet d’adresser des problèmes plus avancés comme :


  L’authentification
  La gestion des erreurs via des Exception Java
  L’upload et le download de fichiers


" />
  
  
  
    <meta name="author" content="Emmanuel Vinas">
    <link rel="author" href="https://plus.google.com/+vinasemmanuel"/>
    
      <link rel="publisher" href="https://plus.google.com/+vinasemmanuel"/>
    
  
    <meta name="author" content="Igor Laborie">
    <link rel="author" href="https://plus.google.com/+IgorLaborie"/>
    
      <link rel="publisher" href="https://plus.google.com/+IgorLaborie"/>
    
  
    <meta name="author" content="Bruno Chauvet">
    <link rel="author" href="https://plus.google.com/"/>
    
      <link rel="publisher" href="https://plus.google.com/"/>
    
  
    <meta name="author" content="Arnaud bos">
    <link rel="author" href="https://plus.google.com/"/>
    
      <link rel="publisher" href="https://plus.google.com/"/>
    
  
    <meta name="author" content="Matthieu Caylet">
    <link rel="author" href="https://plus.google.com/"/>
    
      <link rel="publisher" href="https://plus.google.com/"/>
    
  
    <meta name="author" content="Alteanne Fernandez">
    <link rel="author" href="https://plus.google.com/"/>
    
      <link rel="publisher" href="https://plus.google.com/"/>
    
  

  
    <meta property="og:type" content="article"/>
    <meta property="og:article:published_time" content="2016-08-10T00:00:00+02:00">
    
      <meta property="og:article:author:username" content="Emmanuel Vinas">
    
      <meta property="og:article:author:username" content="Igor Laborie">
    
      <meta property="og:article:author:username" content="Bruno Chauvet">
    
      <meta property="og:article:author:username" content="Arnaud bos">
    
      <meta property="og:article:author:username" content="Matthieu Caylet">
    
      <meta property="og:article:author:username" content="Alteanne Fernandez">
    
    
    <meta property="og:article:tag" content="MKTD">
    
    <meta property="og:article:tag" content="Java">
    
    <meta property="og:article:tag" content="REST">
    
    <meta property="og:article:tag" content="Feign">
    
    <meta property="og:article:tag" content="Retrofit">
    
    <meta property="og:article:tag" content="Cookie">
    
  
  
  
  <meta property="og:image" content="http://www.monkeypatch.io/public/images/logos/logo-FeignVsRetrofit.png"/>

  <meta property="og:url" content="http://www.monkeypatch.io/2016/08/10/MKTD-1-feign-vs-retrofit-&-58;-2-aller-plus-loin.html"/>
  <meta property="og:site_name" content="MonkeyPatch"/>
  
  <!-- Twitter tags -->
  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@MonkeyPatch_io" />
  <meta name="twitter:url" content="http://www.monkeypatch.io/2016/08/10/MKTD-1-feign-vs-retrofit-&-58;-2-aller-plus-loin.html">
  <meta name="twitter:title" content="Mktd#1 Feign Vs Retrofit &#58; 2 Aller Plus Loin">
  <meta name="twitter:description" content="Cet article est le deuxième d’une série de trois articles sur les clients REST en java que sont Feign et Retrofit.

Article précédent :
MKTD#1 : Prise en main



Défi 2: Aller plus loin…

Le deuxième défi permet d’adresser des problèmes plus avancés comme :


  L’authentification
  La gestion des erreurs via des Exception Java
  L’upload et le download de fichiers


">
  <meta name="twitter:image" content="http://www.monkeypatch.io/public/images/logos/logo-FeignVsRetrofit.png">

  <!-- Lang --> 
  <link rel="alternate" hreflang="en" href="http://www.monkeypatch.io/en/index" />
  <link rel="alternate" hreflang="fr" href="http://www.monkeypatch.io/index" />
  
  <meta property="og:locale" content="fr_FR"/>
  <meta property="og:locale:alternate" content="en_US"/>
  

  <link rel="shortcut icon" href="favicon.ico">
  
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css?family=Fira+Mono:400,700" rel="stylesheet" type="text/css">
  <link href="http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">

  <!-- Style -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">
  <link id="theme-style" rel="stylesheet" href="/css/main.css">

 <script type="application/ld+json">
  {
    "@context": "http://schema.org",
    
      "@type": "BlogPosting", // 
      "mainEntityOfPage": "http://www.monkeypatch.io/2016/08/10/MKTD-1-feign-vs-retrofit-&-58;-2-aller-plus-loin.html", 
    
    "author": [
      
      { "@type": "Person", "name": "Emmanuel Vinas" },
      
      { "@type": "Person", "name": "Igor Laborie" },
      
      { "@type": "Person", "name": "Bruno Chauvet" },
      
      { "@type": "Person", "name": "Arnaud bos" },
      
      { "@type": "Person", "name": "Matthieu Caylet" },
      
      { "@type": "Person", "name": "Alteanne Fernandez" }
      
    ],
    "name": "MonkeyPatch",
    "headline": "Mktd#1 Feign Vs Retrofit &#58; 2 Aller Plus Loin",
    "image": "http://www.monkeypatch.io/public/images/logos/logo-FeignVsRetrofit.png",
    
      "datePublished": "2016-08-10T00:00:00+02:00",
      "dateModified": "2016-08-10T00:00:00+02:00",
      "datePublished": "2016-08-10T00:00:00+02:00",
    
    "publisher": {
      "@type": "Organization",
      "name": "MonkeyPatch",
      "logo": "http://www.monkeypatch.io/public/images/logos/logo-mkp-blue-x256.png",
      "sameAs": [
        "https://twitter.com/monkeypatch_io","https://www.linkedin.com/company/monkeypatch-io"
      ]
    },
    "description": "Société de conseil et d'expertise en informatique spécialisée dans les nouvelles technologies.",
    "url": "http://www.monkeypatch.io/2016/08/10/MKTD-1-feign-vs-retrofit-&-58;-2-aller-plus-loin.html"
  }
</script>
</head>

<body class="post">
  <header>
  <div class="menu">
    <div class="logo">
      <a href="/index">
        <img alt="Monkey Patch" src="/public/images/logos/logo-monkey.svg">
      </a>
    </div>
    
    <nav class="lang">
      <ul>
        <li class="">
          <a href="en/2016/08/10/MKTD-1-feign-vs-retrofit-&-58;-2-aller-plus-loin.html" >EN</a>
        </li>
        <li class="sep">|</li>
        <li class="active">
          <a href="/2016/08/10/MKTD-1-feign-vs-retrofit-&-58;-2-aller-plus-loin.html" >FR</a>
        </li>
      </ul>
    </nav>
    
    <nav class="menu">
      <ul>
        
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
            <li class="">
              <a href="/expert">Notre Expertise</a>
            </li>
          
        
          
            <li class="">
              <a href="/about">Notre Philo</a>
            </li>
          
        
          
            <li class="">
              <a href="/careers">Être Monkeys</a>
            </li>
          
        
          
            <li class="">
              <a href="/job">Nos Jobs</a>
            </li>
          
        
          
            <li class="">
              <a href="/contact">Contact</a>
            </li>
          
        
        <li class="">
          <a href="/blog">Blog</a>
        </li>
      </ul>
    </nav>
      
    <nav class="hamburger">
      <label for="menu-hamburger">
        <i class="fa fa-bars" aria-hidden="true"></i>
      </label>
    </nav>
    
  </div>
  <input type="checkbox" id="menu-hamburger"/>
  <nav class="menu-hamburger">
     <ul>
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
            <li class="">
              <a href="/expert">Notre Expertise</a>
            </li>
          
        
          
            <li class="">
              <a href="/about">Notre Philo</a>
            </li>
          
        
          
            <li class="">
              <a href="/careers">Être Monkeys</a>
            </li>
          
        
          
            <li class="">
              <a href="/job">Nos Jobs</a>
            </li>
          
        
          
            <li class="">
              <a href="/contact">Contact</a>
            </li>
          
        
        <li class="">
          <a href="/blog">Blog</a>
        </li>
      </ul>
      <ul class="lang">
        <li class="">
          <a href="en/2016/08/10/MKTD-1-feign-vs-retrofit-&-58;-2-aller-plus-loin.html" >EN</a>
        </li>
        <li class="active">
          <a href="/2016/08/10/MKTD-1-feign-vs-retrofit-&-58;-2-aller-plus-loin.html" >FR</a>
        </li>
      </ul>
  </nav>
</header>

  <main>
    <nav class="index"><!-- fill with JS --></nav>
    <section class="post">
      <h1 id="top">
        <span>Mktd#1 Feign Vs Retrofit &#58; 2 Aller Plus Loin</span>
        <div class="share">
          <a class="twitter-share-button"
            href="https://twitter.com/share"
            data-size="large"
            data-via="monkeypatch_io"
            data-text="Mktd#1 Feign Vs Retrofit &#58; 2 Aller Plus Loin"
            data-hashtags="MKTD,Java,REST,Feign,Retrofit,Cookie"
            >Tweet</a>
        </div>
      </h1>

      <span class="date">


  August 10, 2016

</span>

      <div class="tags">
        
          <span>MKTD</span>
        
          <span>Java</span>
        
          <span>REST</span>
        
          <span>Feign</span>
        
          <span>Retrofit</span>
        
          <span>Cookie</span>
        
      </div>

      <article><p>Cet article est le deuxième d’une série de trois articles sur les clients <abbr title="REpresentational State Transfer">REST</abbr> en java que sont Feign et Retrofit.</p>

<p>Article précédent :
<a href="/2016/08/09/MKTD-1-feign-vs-retrofit-&amp;-58;-1-prise-en-main.html"><abbr title="MonkeyTechDays">MKTD</abbr>#1 : Prise en main</a></p>

<hr />

<h2 id="défi-2-aller-plus-loin">Défi 2: Aller plus loin…</h2>

<p>Le deuxième défi permet d’adresser des problèmes plus avancés comme :</p>

<ul>
  <li>L’authentification</li>
  <li>La gestion des erreurs via des <code class="highlighter-rouge">Exception</code> Java</li>
  <li>L’<em>upload</em> et le <em>download</em> de fichiers</li>
</ul>

<!--more-->

<h3 id="authentification-avec-cookie">Authentification avec Cookie</h3>

<p>Afin de gérer le besoin d’authentification, le serveur fournit un mécanisme à base de <a href="https://jwt.io/"><abbr title="Json WebToken">JWT</abbr></a> et de <a href="https://tools.ietf.org/html/rfc6265">Cookies</a>.
Voici l’interface Java décrivant cette nouvelle opération:</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">AuthenticationApi</span> <span class="o">{</span>

    <span class="n">String</span> <span class="nf">login</span><span class="o">(</span><span class="n">LoginPassword</span> <span class="n">loginPassword</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">SecurityException</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table>
</code></pre></div>

<p>Dans l’en-tête de la réponse <abbr title="HyperText Transfer Protocol">HTTP</abbr> se trouve un <code class="highlighter-rouge">Set-Cookie</code> qu’il faut décoder. Ce <em>cookie</em> doit ensuite être envoyé dans les requêtes faites aux autres services.</p>

<blockquote>
  <p>Les solutions à base de <em>token</em> sont un peu plus simples à mettre en oeuvre avec Feign et Retrofit, mais ici, l’objectif n’est pas de faire les choses de la façon la plus simples. Pour plus d’information sur ce sujet vous pouvez regarder <a href="https://auth0.com/blog/angularjs-authentication-with-cookies-vs-token/">ce blog</a>.</p>
</blockquote>

<h3 id="gestion-des-erreurs">Gestion des erreurs</h3>

<p>Pour la gestion des erreurs, le but de l’exercice est de renvoyer une erreur spécifique en fonction du code <abbr title="HyperText Transfer Protocol">HTTP</abbr> retourné par le serveur.
Le code qui détermine l’exception à retourner est le suivant :</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="n">RuntimeException</span> <span class="nf">decodeError</span><span class="o">(</span><span class="kt">int</span> <span class="n">status</span><span class="o">,</span> <span class="n">String</span> <span class="n">message</span><span class="o">,</span> <span class="n">Supplier</span><span class="o">&lt;</span><span class="n">RuntimeException</span><span class="o">&gt;</span> <span class="n">defaultCase</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">switch</span> <span class="o">(</span><span class="n">status</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">case</span> <span class="mi">404</span><span class="o">:</span> <span class="c1">// Not Found</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nf">NoSuchElementException</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
        <span class="k">case</span> <span class="mi">400</span><span class="o">:</span> <span class="c1">// Bad Request</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
        <span class="k">case</span> <span class="mi">401</span><span class="o">:</span> <span class="c1">// Unauthorized</span>
        <span class="k">case</span> <span class="mi">403</span><span class="o">:</span> <span class="c1">// Forbidden</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nf">SecurityException</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
        <span class="k">default</span><span class="o">:</span>
            <span class="k">return</span> <span class="n">defaultCase</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table>
</code></pre></div>

<h2 id="feign">Feign</h2>

<h3 id="astuce-log-des-requêtes-http">Astuce: log des requêtes <abbr title="HyperText Transfer Protocol">HTTP</abbr></h3>

<p>Pour faciliter le développement de ce défi, il est très pratique de pouvoir afficher des <em>logs</em> sur les requêtes ou les réponses <abbr title="HyperText Transfer Protocol">HTTP</abbr>.</p>

<h4 id="quick--dirty">Quick &amp; Dirty</h4>

<p>La solution la plus directe consite à utiliser un <code class="highlighter-rouge">RequestInterceptor</code> qui est appelé par Feign avant que la requête <abbr title="HyperText Transfer Protocol">HTTP</abbr> ne soit construite, et <em>logger</em> via un <code class="highlighter-rouge">System.out</code>.</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="n">Feign</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
        <span class="o">.</span><span class="na">interceptor</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">)</span> <span class="c1">// Quick &amp; Dirty debug</span>
        <span class="o">.</span><span class="na">decoder</span><span class="o">(</span><span class="k">new</span> <span class="n">GsonDecoder</span><span class="o">())</span>
        <span class="o">.</span><span class="na">encoder</span><span class="o">(</span><span class="k">new</span> <span class="n">GsonEncoder</span><span class="o">())</span>
        <span class="o">.</span><span class="na">target</span><span class="o">(</span><span class="n">MonkeyRaceApi</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">url</span><span class="o">);</span>
</pre></td></tr></tbody></table>
</code></pre></div>

<p>Evidement, ça ne marche que pour la requête <abbr title="HyperText Transfer Protocol">HTTP</abbr>, pour la réponse il faudrait faire quelque chose d’équivalent dans un décodeur.</p>

<h4 id="solution-avec-un-logger-feign">Solution avec un logger Feign</h4>

<p>Pour éviter d’avoir des dépendances sur bibliothèques tierces, Feign à définit son propre <code class="highlighter-rouge">Logger</code>. C’est une classe abstraite avec une seule méthode à implémenter.
Il faut ensuite définir le niveau de <em>log</em> souhaité: <code class="highlighter-rouge">NONE</code>, <code class="highlighter-rouge">BASIC</code>, <code class="highlighter-rouge">HEADERS</code>, <code class="highlighter-rouge">FULL</code>.
Voici ce que ça donne:</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="n">Feign</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
        <span class="o">.</span><span class="na">logLevel</span><span class="o">(</span><span class="n">Logger</span><span class="o">.</span><span class="na">Level</span><span class="o">.</span><span class="na">FULL</span><span class="o">)</span>
        <span class="o">.</span><span class="na">logger</span><span class="o">(</span><span class="k">new</span> <span class="n">Logger</span><span class="o">()</span> <span class="o">{</span> <span class="c1">// implements Feign abstract Logger</span>
            <span class="nd">@Override</span>
            <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">log</span><span class="o">(</span><span class="n">String</span> <span class="n">configKey</span><span class="o">,</span> <span class="n">String</span> <span class="n">format</span><span class="o">,</span> <span class="n">Object</span><span class="o">...</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"[%s] "</span><span class="o">,</span> <span class="n">configKey</span><span class="o">);</span>
                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="n">format</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">})</span>
        <span class="o">.</span><span class="na">decoder</span><span class="o">(</span><span class="k">new</span> <span class="n">GsonDecoder</span><span class="o">())</span>
        <span class="o">.</span><span class="na">encoder</span><span class="o">(</span><span class="k">new</span> <span class="n">GsonEncoder</span><span class="o">())</span>
        <span class="o">.</span><span class="na">target</span><span class="o">(</span><span class="n">MonkeyRaceApi</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">url</span><span class="o">);</span>
</pre></td></tr></tbody></table>
</code></pre></div>

<p>Dans Feign, le <code class="highlighter-rouge">feign.Logger.JavaLogger</code> implémente le mécanisme au travers du <em>loggeur</em> du <abbr title="Java Development Kit">JDK</abbr> (<code class="highlighter-rouge">java.util.logging.Logger</code>), et il existe bien sûr une extension pour utiliser <a href="https://github.com/OpenFeign/feign/tree/master/slf4j">SLF4J</a>.</p>

<h3 id="authentification-avec-cookie-1">Authentification avec Cookie</h3>

<p>La première étape consiste à récupérer le <em>cookie</em> généré par la requête d’authentification. Pour cela on utilise un décodeur spécifique qui va traiter les en-têtes de la réponse pour stocker les <em>cookies</em>.</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">getAuthToken</span><span class="o">(</span><span class="n">String</span> <span class="n">url</span><span class="o">,</span> <span class="n">String</span> <span class="n">login</span><span class="o">,</span> <span class="n">String</span> <span class="n">password</span><span class="o">)</span> <span class="o">{</span>
   <span class="n">AuthenticationApi</span> <span class="n">authenticationApi</span> <span class="o">=</span> <span class="n">builder</span>
           <span class="o">.</span><span class="na">encoder</span><span class="o">(</span><span class="k">new</span> <span class="n">GsonEncoder</span><span class="o">())</span>
           <span class="o">.</span><span class="na">decoder</span><span class="o">((</span><span class="n">response</span><span class="o">,</span> <span class="n">type</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">handleCookies</span><span class="o">(</span><span class="n">response</span><span class="o">.</span><span class="na">headers</span><span class="o">()))</span> <span class="c1">// decode cookies</span>
           <span class="o">.</span><span class="na">target</span><span class="o">(</span><span class="n">AuthenticationApi</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">url</span><span class="o">);</span>
   <span class="k">return</span> <span class="n">authenticationApi</span><span class="o">.</span><span class="na">login</span><span class="o">(</span><span class="k">new</span> <span class="n">LoginPassword</span><span class="o">(</span><span class="n">login</span><span class="o">,</span> <span class="n">password</span><span class="o">));</span>
<span class="o">}</span>
</pre></td></tr></tbody></table>
</code></pre></div>

<p>Le stockage du <em>cookie</em> est assuré par le <a href="https://docs.oracle.com/javase/8/docs/api/index.html?overview-summary.html">CookieManager</a> disponible depuis Java 6.</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">CookieManager</span> <span class="n">COOKIE_MANAGER</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CookieManager</span><span class="o">();</span>
</pre></td></tr></tbody></table>
</code></pre></div>

<p>L’utilisation de ce <code class="highlighter-rouge">CookieManager</code> est traité dans la méthode <code class="highlighter-rouge">handleCookies</code> ci dessous:</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">handleCookies</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span> <span class="n">headers</span><span class="o">)</span> <span class="o">{</span>
   <span class="c1">// From Map&lt;String, Collection&lt;String&gt;&gt; to Map&lt;String, List&lt;String&gt;&gt;</span>
   <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span> <span class="n">h</span> <span class="o">=</span> <span class="n">headers</span><span class="o">.</span><span class="na">entrySet</span><span class="o">().</span><span class="na">stream</span><span class="o">()</span>
           <span class="o">.</span><span class="na">collect</span><span class="o">(</span>
             <span class="n">toMap</span><span class="o">(</span>
               <span class="n">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">::</span><span class="n">getKey</span><span class="o">,</span>
               <span class="n">entry</span> <span class="o">-&gt;</span> <span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">().</span><span class="na">stream</span><span class="o">().</span><span class="na">collect</span><span class="o">(</span><span class="n">toList</span><span class="o">()))</span>
            <span class="o">);</span>
   <span class="k">try</span> <span class="o">{</span>
       <span class="n">URI</span> <span class="n">uri</span> <span class="o">=</span> <span class="n">URI</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">BASE_URL</span><span class="o">);</span><span class="n">image</span>
       <span class="n">COOKIE_MANAGER</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">uri</span><span class="o">,</span> <span class="n">h</span><span class="o">);</span>
       <span class="k">return</span> <span class="n">COOKIE_MANAGER</span><span class="o">.</span><span class="na">getCookieStore</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="n">uri</span><span class="o">).</span><span class="na">stream</span><span class="o">()</span> <span class="c1">// Stream&lt;HttpCookie&gt;</span>
               <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">cookie</span> <span class="o">-&gt;</span> <span class="s">"token"</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">cookie</span><span class="o">.</span><span class="na">getName</span><span class="o">()))</span>
               <span class="o">.</span><span class="na">findFirst</span><span class="o">()</span> <span class="c1">// Optional&lt;HttpCookie&gt;</span>
               <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="nl">HttpCookie:</span><span class="o">:</span><span class="n">getValue</span><span class="o">)</span>
               <span class="o">.</span><span class="na">orElseThrow</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="n">IllegalStateException</span><span class="o">(</span><span class="s">"Authentication cookie not found"</span><span class="o">));</span>
   <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
       <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
   <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table>
</code></pre></div>

<p>Une fois stocké, ce <em>cookie</em> sera envoyé dans les futures requêtes.
Pour cela on utilise une nouvelle fois le mécanisme de <code class="highlighter-rouge">RequestInterceptor</code> qui permet de modifier le <code class="highlighter-rouge">RequestTemplate</code>, Feign utilise cet objet pour construire la requête <abbr title="HyperText Transfer Protocol">HTTP</abbr>.</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="kd">static</span> <span class="n">MonkeyRaceApi</span> <span class="nf">buildRaceApi</span><span class="o">(</span><span class="n">String</span> <span class="n">url</span><span class="o">,</span> <span class="n">String</span> <span class="n">login</span><span class="o">,</span> <span class="n">String</span> <span class="n">password</span><span class="o">)</span> <span class="o">{</span>
   <span class="n">getAuthToken</span><span class="o">(</span><span class="n">url</span><span class="o">,</span> <span class="n">login</span><span class="o">,</span> <span class="n">password</span><span class="o">);</span>
   <span class="k">return</span> <span class="n">builder</span>
           <span class="o">.</span><span class="na">requestInterceptor</span><span class="o">(</span><span class="nl">ApiFactory:</span><span class="o">:</span><span class="n">addCookies</span><span class="o">)</span> <span class="c1">// Inject Cookies</span>
           <span class="o">.</span><span class="na">decoder</span><span class="o">(</span><span class="k">new</span> <span class="n">GsonDecoder</span><span class="o">())</span>
           <span class="o">.</span><span class="na">encoder</span><span class="o">(</span><span class="k">new</span> <span class="n">GsonEncoder</span><span class="o">())</span>
           <span class="o">.</span><span class="na">target</span><span class="o">(</span><span class="n">MonkeyRaceApi</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">url</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table>
</code></pre></div>

<p>L’intercepteur se comporte comme un consommateur de <code class="highlighter-rouge">RequestTemplate</code> :</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">addCookies</span><span class="o">(</span><span class="n">RequestTemplate</span> <span class="n">template</span><span class="o">)</span> <span class="o">{</span>
   <span class="n">URI</span> <span class="n">uri</span> <span class="o">=</span> <span class="n">URI</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">BASE_URL</span><span class="o">);</span>
   <span class="n">COOKIE_MANAGER</span><span class="o">.</span><span class="na">getCookieStore</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="n">uri</span><span class="o">).</span><span class="na">stream</span><span class="o">()</span>
           <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="nl">HttpCookie:</span><span class="o">:</span><span class="n">toString</span><span class="o">)</span>
           <span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">cookie</span> <span class="o">-&gt;</span> <span class="n">template</span><span class="o">.</span><span class="na">header</span><span class="o">(</span><span class="s">"Cookie"</span><span class="o">,</span> <span class="n">cookie</span><span class="o">));</span>
<span class="o">}</span>
</pre></td></tr></tbody></table>
</code></pre></div>

<p>Dans Feign, le mécanisme d’authentification par <em>cookie</em> est proche du mécanisme d’en-tête <code class="highlighter-rouge">Authorization</code> souvent associé au <abbr title="Json WebToken">JWT</abbr>. Il se base sur des en-têtes <abbr title="HyperText Transfer Protocol">HTTP</abbr>. Pour implémenter l’authentification à base de <em>token</em>, on utiliserait donc la même technique du <code class="highlighter-rouge">RequestInterceptor</code>. On constate quand même que l’utilisation des <em>cookies</em> alourdi fortement le code.</p>

<blockquote>
  <p>On peut aussi utiliser une <code class="highlighter-rouge">feign.Target</code> pour traiter les aspects d’authentification, voir la <a href="https://github.com/OpenFeign/feign#setting-headers-per-target">documentation de Feign</a>.</p>
</blockquote>

<h3 id="gestion-des-erreurs-1">Gestion des erreurs</h3>

<p>Dans Feign, il existe un mécanisme spécifique pour traiter les cas en erreurs, c’est à dire si la réponse <abbr title="HyperText Transfer Protocol">HTTP</abbr> à un code ≥ 400. Ce  mécanisme utilise un <code class="highlighter-rouge">ErrorDecoder</code> :</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="kd">static</span> <span class="n">MonkeyRaceApi</span> <span class="nf">buildRaceApi</span><span class="o">(</span><span class="n">String</span> <span class="n">url</span><span class="o">,</span> <span class="n">String</span> <span class="n">login</span><span class="o">,</span> <span class="n">String</span> <span class="n">password</span><span class="o">)</span> <span class="o">{</span>
   <span class="n">getAuthToken</span><span class="o">(</span><span class="n">url</span><span class="o">,</span> <span class="n">login</span><span class="o">,</span> <span class="n">password</span><span class="o">);</span>
   <span class="k">return</span> <span class="n">builder</span>
           <span class="o">.</span><span class="na">errorDecoder</span><span class="o">(</span><span class="nl">ApiFactory:</span><span class="o">:</span><span class="n">decodeError</span><span class="o">)</span> <span class="c1">// Decode errors</span>
           <span class="o">.</span><span class="na">requestInterceptor</span><span class="o">(</span><span class="nl">ApiFactory:</span><span class="o">:</span><span class="n">addCookies</span><span class="o">)</span> <span class="c1">// Inject Cookies</span>
           <span class="o">.</span><span class="na">decoder</span><span class="o">(</span><span class="k">new</span> <span class="n">GsonDecoder</span><span class="o">())</span>
           <span class="o">.</span><span class="na">encoder</span><span class="o">(</span><span class="k">new</span> <span class="n">GsonEncoder</span><span class="o">())</span>
           <span class="o">.</span><span class="na">target</span><span class="o">(</span><span class="n">MonkeyRaceApi</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">url</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table>
</code></pre></div>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="kd">static</span> <span class="n">Exception</span> <span class="nf">decodeError</span><span class="o">(</span><span class="n">String</span> <span class="n">methodKey</span><span class="o">,</span> <span class="n">Response</span> <span class="n">response</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">decodeError</span><span class="o">(</span><span class="n">response</span><span class="o">.</span><span class="na">status</span><span class="o">(),</span> <span class="n">methodKey</span><span class="o">,</span>
            <span class="o">()</span> <span class="o">-&gt;</span> <span class="n">FeignException</span><span class="o">.</span><span class="na">errorStatus</span><span class="o">(</span><span class="n">methodKey</span><span class="o">,</span> <span class="n">response</span><span class="o">));</span>
<span class="o">}</span>
</pre></td></tr></tbody></table>
</code></pre></div>

<blockquote>
  <p>Parfois on souhaite traiter le cas particulier d’une erreur <code class="highlighter-rouge">404</code> dans le <code class="highlighter-rouge">Decoder</code> utilisé dans le cas nominal, pour celà il suffit d’utiliser la méthode <code class="highlighter-rouge">feign.Feign.Builder#decode404</code> sur le <em>builder</em>.</p>
</blockquote>

<h3 id="upload">Upload</h3>

<p>Concernant l’<em>upload</em> de fichier, le serveur <abbr title="REpresentational State Transfer">REST</abbr> propose deux solutions:</p>

<ul>
  <li>un <em>upload</em> via un <a href="https://www.ietf.org/rfc/rfc2388.txt">formulaire multipart</a> avec l’en-tête <code class="highlighter-rouge">Content-type</code> à <code class="highlighter-rouge">multipart/form-data</code></li>
  <li>un <em>upload</em> direct avec les données du fichier directement dans le corps de la requête, l’en-tête <code class="highlighter-rouge">Content-type</code> à <code class="highlighter-rouge">application/octet-stream</code>.</li>
</ul>

<p>Les deux solutions sont implémetables en utilisant le même principe: un <code class="highlighter-rouge">Decoder</code> spécifique.
La seconde solution est beaucoup plus simple à implémenter car gérer le corps d’une requête <em>multipart</em> nécessite l’utilisation d’une <abbr title="Application Programming Interface">API</abbr> externe (par exemple <a href="https://commons.apache.org/proper/commons-fileupload/">Commons FileUpload d’Apache</a>).
On peut regarder du coté de <a href="https://github.com/xxlabaza/feign-form">https://github.com/xxlabaza/feign-form</a> ou <a href="https://github.com/pcan/feign-client-test">https://github.com/pcan/feign-client-test</a> pour voir des solutions ou des idées pour ces aspects <em>multipart</em>.</p>

<p>La seconde solution est donc beaucoup plus simple, le principe est de traiter le cas particulier des objets du type <code class="highlighter-rouge">java.io.InputStream</code> et de déléguer les autres cas à un autre encodeur <abbr title="JavaScript Object Notation">JSON</abbr> classique. Pour définir le corps de de la requête <abbr title="HyperText Transfer Protocol">HTTP</abbr> il faut appeler la méthode <code class="highlighter-rouge">feign.RequestTemplate#body(byte[], java.nio.charset.Charset)</code>.
Il est possible d’écrire le code d’un encodeur dans une <em>lambda</em> Java 8, mais ici il est préférable d’extraire le code de ce décodeur dans une nouvelle classe :</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">UploadEncoder</span> <span class="kd">implements</span> <span class="n">Encoder</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Encoder</span> <span class="n">delegate</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">UploadEncoder</span><span class="o">(</span><span class="n">Encoder</span> <span class="n">encoder</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">();</span>
        <span class="n">delegate</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">encode</span><span class="o">(</span><span class="n">Object</span> <span class="n">object</span><span class="o">,</span> <span class="n">Type</span> <span class="n">bodyType</span><span class="o">,</span> <span class="n">RequestTemplate</span> <span class="n">template</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">EncodeException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">InputStream</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">bodyType</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">template</span><span class="o">.</span><span class="na">header</span><span class="o">(</span><span class="s">"Content-type"</span><span class="o">,</span> <span class="s">"application/octet-stream"</span><span class="o">);</span>
            <span class="n">InputStream</span> <span class="n">inputStream</span> <span class="o">=</span> <span class="n">InputStream</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">cast</span><span class="o">(</span><span class="n">object</span><span class="o">);</span>
            <span class="c1">// InputStream to byte[]</span>
            <span class="k">try</span> <span class="o">(</span><span class="n">BufferedInputStream</span> <span class="n">bin</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BufferedInputStream</span><span class="o">(</span><span class="n">inputStream</span><span class="o">);</span>
                 <span class="n">ByteArrayOutputStream</span> <span class="n">bos</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ByteArrayOutputStream</span><span class="o">())</span> <span class="o">{</span>
                <span class="kt">byte</span><span class="o">[]</span> <span class="n">buffer</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="mi">1024</span><span class="o">];</span>
                <span class="kt">int</span> <span class="n">bytesRead</span><span class="o">;</span>
                <span class="k">while</span> <span class="o">((</span><span class="n">bytesRead</span> <span class="o">=</span> <span class="n">bin</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">buffer</span><span class="o">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">bos</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">buffer</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">bytesRead</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="n">bos</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
                <span class="n">template</span><span class="o">.</span><span class="na">body</span><span class="o">(</span><span class="n">bos</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">(),</span> <span class="n">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">EncodeException</span><span class="o">(</span><span class="s">"Cannot upload file"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">delegate</span><span class="o">.</span><span class="na">encode</span><span class="o">(</span><span class="n">object</span><span class="o">,</span> <span class="n">bodyType</span><span class="o">,</span> <span class="n">template</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table>
</code></pre></div>

<blockquote>
  <p>On peut bien sûr simplifier le code en utilisant une bibliothèque qui permet facilement de faire la conversion <code class="highlighter-rouge">InputStream</code> vers <code class="highlighter-rouge">byte[]</code>, mais ça ne fait pas de mal d’écrire des <code class="highlighter-rouge">try with resources</code> de temps en temps.</p>
</blockquote>

<blockquote>
  <p>On peut légitimement argumenter que ce code risque de poser des problèmes si le fichier est particulièrement gros. Mais si on doit gérer ce genre de cas, il faut aussi se poser la question suivante: une <abbr title="Application Programming Interface">API</abbr> <abbr title="REpresentational State Transfer">REST</abbr> est elle la bonne solution pour faire des <em>upload</em> de gros fichier ?</p>
</blockquote>

<h3 id="download">Download</h3>

<p>On utilise un <code class="highlighter-rouge">feign.Decoder</code> pour le <em>download</em>, le principe est similaire à celui utiliser pour l’<em>upload</em>. Ce qui va donner:</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DownloadDecoder</span> <span class="kd">implements</span> <span class="n">Decoder</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Decoder</span> <span class="n">delegate</span><span class="o">;</span>

    <span class="n">DownloadDecoder</span><span class="o">(</span><span class="n">Decoder</span> <span class="n">decoder</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">();</span>
        <span class="n">delegate</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">decode</span><span class="o">(</span><span class="n">Response</span> <span class="n">response</span><span class="o">,</span> <span class="n">Type</span> <span class="n">type</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">DecodeException</span><span class="o">,</span> <span class="n">FeignException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">InputStream</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">type</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="na">body</span><span class="o">().</span><span class="na">asInputStream</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">delegate</span><span class="o">.</span><span class="na">decode</span><span class="o">(</span><span class="n">response</span><span class="o">,</span> <span class="n">type</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table>
</code></pre></div>

<p>Une nouvelle fois, Feign rend l’opération très simple dès qu’on a compris le principe des encodeurs/décodeurs.</p>

<h3 id="bilan">Bilan</h3>

<p>Feign rend la manipulation des en-têtes <abbr title="HyperText Transfer Protocol">HTTP</abbr> très simple, cela permet d’utiliser les divers mécanismes d’autentifications par <em>Cookie</em> ou <em>Token</em> facilement.</p>

<p>La gestion des erreurs dans Feign est aussi triviale, c’est un des points fort de Feign par rapport à Retrofit.</p>

<p>Le mécanisme d’encodeur permet facilement de traiter le cas d’<em>upload</em> du fichier, et de façon plus générale de traiter tous les cas de <em>serialization</em> des requêtes <abbr title="HyperText Transfer Protocol">HTTP</abbr>.
Le mécanisme de décodeur va permettre de récupérer le contenu d’un fichier que l’on <em>download</em>, ou plus généralement les divers mécanismes de <em>deserialization</em> des réponses <abbr title="HyperText Transfer Protocol">HTTP</abbr>.</p>

<p>Feign offre une grande souplesse grace aux <code class="highlighter-rouge">Encoder</code>, <code class="highlighter-rouge">Decoder</code>, <code class="highlighter-rouge">RequestInterceptor</code>, … on arrive assez facilement à résoudre les divers problèmes posés autours des <abbr title="Application Programming Interface">API</abbr> <abbr title="REpresentational State Transfer">REST</abbr>.</p>

<h2 id="retrofit">Retrofit</h2>

<h3 id="authentification-avec-cookie-2">Authentification avec Cookie</h3>

<p>La façon la plus simple de gérer l’authentification avec Retrofit consiste à utiliser les mécanismes du client <abbr title="HyperText Transfer Protocol">HTTP</abbr> (<code class="highlighter-rouge">okHttp3</code>). Comme pour feign, on fait une première requête qui récupère le cookie et ensuite on utilise le même client pour les autres requêtes. 
Une autre solution consiste a utiliser un client par requête mais une  seule instance de <code class="highlighter-rouge">cookieJar</code>.</p>

<p>Voici une première implémentation assez basique qui permet de comprendre le mécanisme du <code class="highlighter-rouge">cookieJar</code>.</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="n">client</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OkHttpClient</span><span class="o">.</span><span class="na">Builder</span><span class="o">()</span>
        <span class="o">.</span><span class="na">cookieJar</span><span class="o">(</span>
                <span class="k">new</span> <span class="nf">CookieJar</span><span class="o">()</span> <span class="o">{</span>
                    <span class="kd">private</span> <span class="kd">final</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Cookie</span><span class="o">&gt;&gt;</span> <span class="n">cookieStore</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>

                        <span class="nd">@Override</span>
                        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">saveFromResponse</span><span class="o">(</span><span class="n">HttpUrl</span> <span class="n">url</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Cookie</span><span class="o">&gt;</span> <span class="n">cookies</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">cookieStore</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">url</span><span class="o">.</span><span class="na">uri</span><span class="o">().</span><span class="na">getAuthority</span><span class="o">(),</span> <span class="n">cookies</span><span class="o">);</span>
                        <span class="o">}</span>

                        <span class="nd">@Override</span>
                        <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Cookie</span><span class="o">&gt;</span> <span class="nf">loadForRequest</span><span class="o">(</span><span class="n">HttpUrl</span> <span class="n">url</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">List</span><span class="o">&lt;</span><span class="n">Cookie</span><span class="o">&gt;</span> <span class="n">cookies</span> <span class="o">=</span> <span class="n">cookieStore</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">url</span><span class="o">.</span><span class="na">uri</span><span class="o">().</span><span class="na">getAuthority</span><span class="o">());</span>
                            <span class="k">return</span> <span class="n">cookies</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">cookies</span> <span class="o">:</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Cookie</span><span class="o">&gt;();</span>
                    <span class="o">}</span>
                <span class="o">});</span>
</pre></td></tr></tbody></table>
</code></pre></div>

<p>Une implémentation plus élégante et plus simple consiste à ajouter la dépendance <code class="highlighter-rouge">okhttp-urlconnection</code> de <code class="highlighter-rouge">OkHttp</code>.</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="n">CookieHandler</span> <span class="n">cookieHandler</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CookieManager</span><span class="o">(</span>
            <span class="k">new</span> <span class="nf">PersistentCookieStore</span><span class="o">(</span><span class="n">ctx</span><span class="o">),</span> <span class="n">CookiePolicy</span><span class="o">.</span><span class="na">ACCEPT_ALL</span><span class="o">);</span>

<span class="n">OkHttpClient</span> <span class="n">httpClient</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OkHttpClient</span><span class="o">.</span><span class="na">Builder</span><span class="o">()</span>
            <span class="o">.</span><span class="na">cookieJar</span><span class="o">(</span><span class="k">new</span> <span class="n">JavaNetCookieJar</span><span class="o">(</span><span class="n">cookieHandler</span><span class="o">));</span>
</pre></td></tr></tbody></table>
</code></pre></div>

<h3 id="gestion-des-erreurs-2">Gestion des erreurs</h3>

<p>Il n’existe pas, de mon point de vue de solution idéale dans Retrofit pour gérer les erreurs comment il en existe dans Feign.
Pour cet exercice, nous utilisons donc la fonctionnalité d’interceptor de <code class="highlighter-rouge">OkHttp</code>. Une limitation existe cependant; il faut que les exceptions à retourner soient de type <code class="highlighter-rouge">RuntimeException</code>.</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="n">OkHttpClient</span> <span class="n">client</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OkHttpClient</span><span class="o">.</span><span class="na">Builder</span><span class="o">()</span>
        <span class="o">.</span><span class="na">addInterceptor</span><span class="o">(</span><span class="k">this</span><span class="o">::</span><span class="n">authInterceptor</span><span class="o">);</span>
</pre></td></tr></tbody></table>
</code></pre></div>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="kd">private</span> <span class="n">Response</span> <span class="nf">authInterceptor</span><span class="o">(</span><span class="n">Interceptor</span><span class="o">.</span><span class="na">Chain</span> <span class="n">chain</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
    <span class="n">Request</span> <span class="n">request</span> <span class="o">=</span> <span class="n">chain</span><span class="o">.</span><span class="na">request</span><span class="o">();</span>
    <span class="n">Response</span> <span class="n">response</span> <span class="o">=</span> <span class="n">chain</span><span class="o">.</span><span class="na">proceed</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>

    <span class="k">if</span> <span class="o">(!</span><span class="n">response</span><span class="o">.</span><span class="na">isSuccessful</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">RuntimeException</span> <span class="n">ex</span> <span class="o">=</span> <span class="n">ApiFactory</span><span class="o">.</span><span class="na">decodeError</span><span class="o">(</span><span class="n">response</span><span class="o">.</span><span class="na">code</span><span class="o">(),</span> <span class="n">response</span><span class="o">.</span><span class="na">message</span><span class="o">(),</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="kc">null</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">ex</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="n">ex</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">response</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table>
</code></pre></div>

<h3 id="upload-1">Upload</h3>

<p>Pour l’<em>upload</em> , nous avons choisi d’utiliser la méthode du <a href="https://www.ietf.org/rfc/rfc2388.txt">formulaire multipart</a> avec l’en-tête <code class="highlighter-rouge">Content-type</code> à <code class="highlighter-rouge">multipart/form-data</code></p>

<p>Et voici comment faire :</p>

<p>On ajoute la méthode au service.</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">MonkeyService</span> <span class="o">{</span>

    <span class="nd">@Multipart</span>
    <span class="nd">@POST</span><span class="o">(</span><span class="s">"monkeys/{id}/photo"</span><span class="o">)</span>
    <span class="n">Call</span><span class="o">&lt;</span><span class="n">Photo</span><span class="o">&gt;</span> <span class="nf">sendPhoto</span><span class="o">(</span><span class="nd">@Path</span><span class="o">(</span><span class="s">"id"</span><span class="o">)</span> <span class="n">String</span> <span class="n">id</span><span class="o">,</span> <span class="nd">@Part</span> <span class="n">MultipartBody</span><span class="o">.</span><span class="na">Part</span> <span class="n">file</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table>
</code></pre></div>

<p>On crée un fichier temporaire contenant la photo, puis on appelle la méthode <code class="highlighter-rouge">sendPhoto</code> en lui fournissant un <code class="highlighter-rouge">RequestBody</code> spécifique contenant ce fichier temporaire et ensuite nous créons le <code class="highlighter-rouge">MultipartBody</code> qui est passé au service.</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="nd">@Override</span>
<span class="kd">public</span> <span class="n">Photo</span> <span class="nf">savePhoto</span><span class="o">(</span><span class="n">String</span> <span class="n">id</span><span class="o">,</span> <span class="n">InputStream</span> <span class="n">stream</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">SecurityException</span><span class="o">,</span> <span class="n">IllegalArgumentException</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">executeCall</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">Path</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">Files</span><span class="o">.</span><span class="na">createTempFile</span><span class="o">(</span><span class="s">"exo2"</span><span class="o">,</span> <span class="s">"upload"</span><span class="o">);</span>
            <span class="n">Files</span><span class="o">.</span><span class="na">copy</span><span class="o">(</span><span class="n">stream</span><span class="o">,</span> <span class="n">tmp</span><span class="o">,</span> <span class="n">REPLACE_EXISTING</span><span class="o">);</span>

            <span class="n">RequestBody</span> <span class="n">requestFile</span> <span class="o">=</span> <span class="n">RequestBody</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">MediaType</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="s">"multipart/form-data"</span><span class="o">),</span> <span class="n">tmp</span><span class="o">.</span><span class="na">toFile</span><span class="o">());</span>
            <span class="n">MultipartBody</span><span class="o">.</span><span class="na">Part</span> <span class="n">body</span> <span class="o">=</span> <span class="n">MultipartBody</span><span class="o">.</span><span class="na">Part</span><span class="o">.</span><span class="na">createFormData</span><span class="o">(</span><span class="s">"photo"</span><span class="o">,</span> <span class="n">tmp</span><span class="o">.</span><span class="na">toFile</span><span class="o">().</span><span class="na">getName</span><span class="o">(),</span> <span class="n">requestFile</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">monkeyService</span><span class="o">.</span><span class="na">sendPhoto</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">body</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">});</span>
<span class="o">}</span>
</pre></td></tr></tbody></table>
</code></pre></div>

<h3 id="download-1">Download</h3>

<p>Pour le <em>download</em> il nous suffit de faire un appel à notre service en récupérant le corps de la réponse.
Pour cela Retrofit dispose d’un type <em>générique</em>: <code class="highlighter-rouge">ResponseBody</code> qui permet de récupérer la réponse <code class="highlighter-rouge">brute</code>.</p>

<p>On commence par ajouter la méthode à notre service :</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">MonkeyService</span> <span class="o">{</span>
    <span class="nd">@GET</span><span class="o">(</span><span class="s">"monkeys/{id}/photo"</span><span class="o">)</span>
    <span class="n">Call</span><span class="o">&lt;</span><span class="n">ResponseBody</span><span class="o">&gt;</span> <span class="nf">downloadPhoto</span><span class="o">(</span><span class="nd">@Path</span><span class="o">(</span><span class="s">"id"</span><span class="o">)</span> <span class="n">String</span> <span class="n">id</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">SecurityException</span><span class="o">,</span> <span class="n">IllegalArgumentException</span><span class="o">;</span>
  <span class="o">}</span>
</pre></td></tr></tbody></table>
</code></pre></div>

<p>puis voici le code qui permet de récupérer notre photo :</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="nd">@Override</span>
<span class="kd">public</span> <span class="n">InputStream</span> <span class="nf">downloadPhoto</span><span class="o">(</span><span class="n">String</span> <span class="n">id</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">SecurityException</span><span class="o">,</span> <span class="n">IllegalArgumentException</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">Response</span><span class="o">&lt;</span><span class="n">ResponseBody</span><span class="o">&gt;</span> <span class="n">response</span> <span class="o">=</span> <span class="n">monkeyService</span><span class="o">.</span><span class="na">downloadPhoto</span><span class="o">(</span><span class="n">id</span><span class="o">).</span><span class="na">execute</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="na">body</span><span class="o">().</span><span class="na">byteStream</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table>
</code></pre></div>

<h3 id="bilan-1">Bilan</h3>

<p>Il est très simple dans Retrofit de gérer l’authentification via <em>Cookie</em>, <em>Token</em>. L’<em>upload</em> et le <em>download</em> sont aussi assez simple à gérer.</p>

<p>En revanche la gestion des erreurs est un peu moins intuitive. Peut être existe t’il une autre solution auquelle nous n’avons pas pensé.</p>

<h2 id="bilan-global">Bilan Global</h2>

<p>Que ce soit avec Feign ou Retrofit, il est aisé de gérer les <em>cookies</em>, et les <em>upload</em>/<em>download</em> de fichiers.</p>

<p>Nous avons également trouvé que la gestion des erreurs en mode synchrone était mieux géré avec Feign.</p>

<p>Les solutions utilisant <a href="http://square.github.io/okhttp/">OkHttp</a> sont communes à Retrofit et à Feign quand on utilise le client <a href="https://github.com/OpenFeign/feign/tree/master/okhttp">okhttp-client</a> dans Feign.</p>

</article>

      <div class="authors">
        
          <div class="author">
            <a href="https://twitter.com/EmmanuelVinas" rel="author">
              <img src="https://lh3.googleusercontent.com/-PPNaC_SZen8/AAAAAAAAAAI/AAAAAAAARt8/lRnd47vDjyM/s46-c-k-no/photo.jpg" alt="Emmanuel Vinas">
              <span>Emmanuel Vinas</span>
            </a>
          </div>
        
          <div class="author">
            <a href="https://twitter.com/ilaborie" rel="author">
              <img src="http://www.gravatar.com/avatar/5870075cc4934bb7c32f2a6c56cc4f8d?s=48" alt="Igor Laborie">
              <span>Igor Laborie</span>
            </a>
          </div>
        
      </div>
    </section>

    
    <section class="comment">
      <div id="disqus_thread"></div>
      <script>
      var disqus_config = function () {
          this.page.url = "http://www.monkeypatch.io/2016/08/10/MKTD-1-feign-vs-retrofit-&-58;-2-aller-plus-loin.html";  // Replace PAGE_URL with your page's canonical URL variable
          this.page.identifier = "/2016/08/10/MKTD-1-feign-vs-retrofit-&-58;-2-aller-plus-loin.html"; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
      };
      (function() { // DON'T EDIT BELOW THIS LINE
          var d = document, s = d.createElement('script');
          s.src = '//monkeypatchblog.disqus.com/embed.js';
          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
      })();
      </script>
      <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </section>
    
    <footer class="top">
    <div>
      <h3>Rester en contact</h3>
      <p>
        <a class="contact" href="contact">
          <i class="fa fa-map-marker" aria-hidden="true"></i>
          <img src="/public/images/icons/Toulouse.png" alt="Toulouse">
        </a>
      </p>
      <p>
        <i class="fa fa-envelope-o" aria-hidden="true"></i>
        <a class="mail" href="mailto:contact@monkeypatch.io">contact@monkeypatch.io</a>
      </p>
    </div>
    <div class="social-network">
      <h3>Réseaux sociaux</h3>
      <ul class="social">
        <li>
          <a href="https://twitter.com/monkeypatch_io">
            <i class="fa fa-twitter" aria-hidden="true"></i>
          </a>
        </li>
        <li>
          <a href="https://www.linkedin.com/company/monkeypatch-io">
            <i class="fa fa-linkedin" aria-hidden="true"></i>
          </a>
        </li>
      </ul>
    </div>
  </div>
</footer>

<footer class="bottom">
  <div>
    Copyright @ 2016 MonkeyPatch -<a href="/terms">Termes et conditions</a>
  </div>
  <div>
    Made with <i class="fa fa-heart" aria-hidden="true"></i> In Toulouse
  </div>
  <a class="goToTop" href="#top">
    <i class="fa fa-caret-up" aria-hidden="true"></i>
  </a>
</footer>

  </main>
  <!-- Google Tag Manager -->
  <noscript>
    <iframe src="//www.googletagmanager.com/ns.html?id=GTM-KGGFWH" height="0" width="0" style="display:none;visibility:hidden"></iframe>
  </noscript>
  <script>
    (function(w, d, s, l, i) {
      w[l] = w[l] || [];
      w[l].push({
        'gtm.start': new Date().getTime(),
        event: 'gtm.js'
      });
      var f = d.getElementsByTagName(s)[0],
        j = d.createElement(s),
        dl = l != 'dataLayer' ? '&l=' + l : '';
      j.async = true;
      j.src =
        '//www.googletagmanager.com/gtm.js?id=' + i + dl;
      f.parentNode.insertBefore(j, f);
    })(window, document, 'script', 'dataLayer', 'GTM-KGGFWH');
  </script>
  <!-- End Google Tag Manager -->
  <script src="/public/scripts/modernizr-custom.js"></script>
  <script>
document.addEventListener('DOMContentLoaded', function () {
  var i;
  var nav = document.querySelector('nav.index');
  var headers = document.querySelectorAll('article h1, article h2, article h3, article h4, article h5, article h6');

  var createNavHeader = function(id, type, text) {
    var link = document.createElement('a');
    link.textContent = text;
    link.setAttribute('href', '#' + id);

    var text = document.createElement(type);
    text.appendChild(link);
    return text;
  };
  var createHeaderLink = function(id, text) {
    var link = document.createElement('a');
    link.classList.add('anchor');
    link.textContent = text;
    link.setAttribute('href', '#' + id);
    return link;
  };

  var processHeader = function(header) {
    var id = header.id;
    var tag = header.tagName;
    var text = header.textContent;

    var navHeader = createNavHeader(id, tag, text);
    nav.appendChild(navHeader);

    var headerLink = createHeaderLink(id, text);
    header.removeChild(header.firstChild);
    header.appendChild(headerLink);
  }

  for (i = 0; i < headers.length; i++) {
    processHeader(headers[i]);
  }
});
  </script>
  <!-- Share with Twitter -->
  <script>window.twttr = (function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0],
    t = window.twttr || {};
  if (d.getElementById(id)) return t;
  js = d.createElement(s);
  js.id = id;
  js.src = "https://platform.twitter.com/widgets.js";
  fjs.parentNode.insertBefore(js, fjs);

  t._e = [];
  t.ready = function(f) {
    t._e.push(f);
  };

  return t;
}(document, "script", "twitter-wjs"));</script>
</body>
</html>
